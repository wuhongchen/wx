<?php
/**
 * 微站风格管理
 * [WeEngine System] Copyright (c) 2013 WE7.CC
 */
defined('IN_IA') or exit('Access Denied');
$templateid = intval($_GPC['templateid']);
$dos = array('default', 'designer', 'module', 'createtemplate', 'template', 'copy', 'styles', 'build', 'del');
$do = in_array($do, $dos) ? $do : 'display';

if($do == 'template') {
	$_W['page']['title'] = '风格管理 - 网站风格设置 - 微站功能';
	$setting = uni_setting($_W['uniacid'], array('styleid'));
	$templates = uni_templates();
	template('site/style');
}

if($do == 'default') {
	load()->model('extension');
	$template = array();
	$templates = uni_templates();
	if(!empty($templates)) {
		foreach($templates as $row) {
			if($row['id'] == $templateid) {
				$template = $row;
				break;
			}
		}
	}
	if(empty($template)) {
		message('抱歉，模板不存在或是您无权限使用！', '', 'error');
	}
	pdo_update('uni_settings', array('styleid' => $templateid), array('uniacid' => $_W['uniacid']));
	//设置默认模板时,检查模板的'设置项'是否已经存入数据库.没有的'设置项'插入,有的不做处理
	$styles = pdo_fetchall("SELECT variable, content FROM " . tablename('site_styles_vars') . " WHERE templateid = :templateid  AND uniacid = '{$_W['uniacid']}'", array(':templateid' => $templateid), 'variable');
	//模板的详细信息
	$templatedata = ext_template_manifest($template['name']);
	
	if(empty($styles)) {
		if(!empty($templatedata['settings'])) {
			foreach($templatedata['settings'] as $variable => $content) {
				pdo_insert('site_styles_vars', array('variable' => $variable, 'content' => $content, 'templateid' => $templateid, 'uniacid' => $_W['uniacid']));
			}
		}
	} else {
		if(!empty($templatedata['settings'])) {
			foreach($templatedata['settings'] as $variable => $value) {
				if(!empty($value) && empty($styles[$variable])) {
					pdo_insert('site_styles_vars', array(
						'content' => $value,
						'templateid' => $templateid,
						'variable' => $variable,
						'uniacid' => $_W['uniacid']
					));
				}
			}
		}
	}
	message('默认模板更新成功！', url('site/style'), 'success');
}

if($do == 'designer') {
	load()->func('tpl');
	$styleid = intval($_GPC['styleid']);
	$style = pdo_fetch("SELECT * FROM ".tablename('site_styles')." WHERE id = :id AND uniacid = '{$_W['uniacid']}'", array(':id' => $styleid));
	if(empty($style)) {
		message('抱歉，风格不存在或是已经被删除！', '', 'error');
	}
	$templateid = $style['templateid'];
	$template = pdo_fetch("SELECT * FROM " . tablename('site_templates') . " WHERE id = '{$templateid}'");
	if(empty($template)) {
		message('抱歉，模板不存在或是已经被删除！', '', 'error');
	}
	$styles = pdo_fetchall("SELECT variable, content FROM " . tablename('site_styles_vars') . " WHERE styleid = :styleid AND uniacid = '{$_W['uniacid']}'", array(':styleid' => $styleid), 'variable');
	if(checksubmit('submit')) {
		if(!empty($_GPC['style'])) {
			foreach($_GPC['style'] as $variable => $value) {
				if(!empty($value)) {
					if(!empty($styles[$variable])) {
						if($styles[$variable] != $value) {
							pdo_update('site_styles_vars', array('content' => $value), array(
								'styleid' => $styleid,
								'variable' => $variable,
							));
						}
						unset($styles[$variable]);
					} else {
						pdo_insert('site_styles_vars', array(
							'content' => $value,
							'templateid' => $templateid,
							'styleid' => $styleid,
							'variable' => $variable,
							'uniacid' => $_W['uniacid']
						));
					}
				}
			}
		}
		if(!empty($_GPC['custom']['name'])) {
			foreach($_GPC['custom']['name'] as $i => $variable) {
				$value = $_GPC['custom']['value'][$i];
				if(!empty($value)) {
					if(!empty($styles[$variable])) {
						if($styles[$variable] != $value) {
							pdo_update('site_styles_vars', array('content' => $value), array(
								'templateid' => $templateid,
								'variable' => $variable,
								'uniacid' => $_W['uniacid']
							));
						}
						unset($styles[$variable]);
					} else {
						pdo_insert('site_styles_vars', array(
							'content' => $value,
							'templateid' => $templateid,
							'styleid' => $styleid,
							'variable' => $variable,
							'uniacid' => $_W['uniacid']
						));
					}
				}
			}
		}
		if(!empty($styles)) {
			pdo_query("DELETE FROM " . tablename('site_styles_vars') . " WHERE variable IN ('" . implode("','", array_keys($styles)) . "') AND styleid = :styleid AND uniacid = '{$_W['uniacid']}'", array(':styleid' => $styleid));
		}
		pdo_update('site_styles', array('name' => $_GPC['name']), array('id' => $styleid));
		message('更新风格成功！', url('site/style/designer', array('styleid' => $styleid)), 'success');
	}
	$systemtags = array(
		'imgdir',
		'indexbgcolor',
		'indexbgimg',
		'indexbgextra',
		'fontfamily',
		'fontsize',
		'fontcolor',
		'fontnavcolor',
		'linkcolor',
		'css'
	);
	template('site/style');
}

if($do == 'module') {
	$_W['page']['title'] = '模块扩展模板说明 - 网站风格设置 - 微站功能';
	if(empty($_W['isfounder'])) {
		message('您无权进行该操作！');
	}
	$setting = uni_setting($_W['uniacid'], array('styleid'));
	$ts = uni_templates();
	$currentTemplate = !empty($ts[$setting['styleid']]) ? $ts[$setting['styleid']]['name'] : 'default';

	$modules = uni_modules();
	$path = IA_ROOT . '/addons';
	if(is_dir($path)) {
		if($handle = opendir($path)) {
			while(false !== ($modulepath = readdir($handle))) {
				if($modulepath != '.' && $modulepath != '..' && !empty($modules[$modulepath])) {
					if(is_dir($path . '/' . $modulepath . '/template/mobile')) {
						if($handle1 = opendir($path . '/' . $modulepath . '/template/mobile')) {
							while(false !== ($mobilepath = readdir($handle1))) {
								if($mobilepath != '.' && $mobilepath != '..' && strexists($mobilepath, '.html')) {
									$templates[$modulepath][] = $mobilepath;
								}
							}
						}
					}
				}
			}
		}
	}
	template('site/style');
}

if($do == 'createtemplate') {
	if(empty($_W['isfounder'])) {
		exit('require founder');
	}
	$name = $_GPC['name'];
	load()->model('module');
	$module = module_fetch($name);
	if(empty($module)) {
		exit('invalid module');
	}

	$file = $_GPC['file'];
	$setting = uni_setting($_W['uniacid'], array('styleid'));
	$ts = uni_templates();
	$currentTemplate = !empty($ts[$setting['styleid']]) ? $ts[$setting['styleid']]['name'] : 'default';

	$targetfile = IA_ROOT . '/app/themes/' . $currentTemplate . '/' . $module['name'] . '/' . $file;
	if(!file_exists($targetfile)) {
		load()->func('file');
		mkdirs(dirname($targetfile));
		file_put_contents($targetfile, '<!-- 原始文件：addons/modules/' . $module['name'] . '/template/mobile/' . $file . ' -->');
		@chmod($targetfile, $_W['config']['setting']['filemode']);
	}
	message('操作成功！', '', 'success');
}

if ($do == 'build') {
	$template = pdo_fetch("SELECT * FROM " . tablename('site_templates') . " WHERE id = '{$templateid}'");
	if(empty($template)) {
		message('抱歉，模板不存在或是已经被删除！', '', 'error');
	}
	list($templatetitle) = explode('_', $template['title']);
	$newstyle = array(
		'uniacid' => $_W['uniacid'],
		'name' => $templatetitle.'_'.random(4),
		'templateid' => $template['id'],
	);
	pdo_insert('site_styles', $newstyle);
	$id = pdo_insertid();
	message('风格复制成功，进入进入“设计风格”界面。', url('site/style/designer', array('templateid' => $template['id'], 'styleid' => $id)), 'success');
}

if ($do == 'styles') {
	$_W['page']['title'] = '风格管理 - 网站风格设置 - 微站功能';
	$styles = pdo_fetchall("SELECT * FROM ".tablename('site_styles')." WHERE uniacid = :uniacid", array(':uniacid' => $_W['uniacid']));
	$templates = uni_templates();
	template('site/style');
}

if($do == 'copy') {
	$styleid = intval($_GPC['styleid']);
	$style = pdo_fetch("SELECT * FROM ".tablename('site_styles')." WHERE id = :id AND uniacid = '{$_W['uniacid']}'", array(':id' => $styleid));
	if(empty($style)) {
		message('抱歉，风格不存在或是已经被删除！', '', 'error');
	}
	$templateid = $style['templateid'];
	$template = pdo_fetch("SELECT * FROM " . tablename('site_templates') . " WHERE id = '{$templateid}'");
	if(empty($template)) {
		message('抱歉，模板不存在或是已经被删除！', '', 'error');
	}
	
	list($name) = explode('_', $style['name']);
	$newstyle = array(
		'uniacid' => $_W['uniacid'],
		'name' => $name.'_'.random(4),
		'templateid' => $style['templateid'],
	);
	pdo_insert('site_styles', $newstyle);
	$id = pdo_insertid();
	
	$styles = pdo_fetchall("SELECT variable, content, templateid, uniacid FROM " . tablename('site_styles_vars') . " WHERE styleid = :styleid AND uniacid = '{$_W['uniacid']}'", array(':styleid' => $styleid));
	if(!empty($styles)) {
		foreach($styles as $data) {
			$data['styleid'] = $id;
			pdo_insert('site_styles_vars', $data);
		}
	}
	message('风格复制成功，进入进入“设计风格”界面。', url('site/style/designer', array('templateid' => $style['templateid'], 'styleid' => $id)), 'success');
} 

if($do == 'del') {
	$styleid = intval($_GPC['styleid']);
	pdo_delete('site_styles_vars', array('uniacid' => $_W['uniacid'], 'styleid' => $styleid));
	pdo_delete('site_styles', array('uniacid' => $_W['uniacid'], 'id' => $styleid));
	message('删除风格成功。', referer(), 'success');
}